<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>배달의 드론 | 상품 수정</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#2AC1BC; --brand-d:#1fa6a1;
      --ink:#0f172a; --muted:#6b7280;
      --card:#ffffff; --bg:#f6f8fb; --line:#e5e7eb;
      --radius:20px; --shadow:0 18px 44px rgba(2,6,23,.10), 0 6px 18px rgba(2,6,23,.06);
      --glass:rgba(255,255,255,.75); --danger:#ef4444; --danger-d:#dc2626;
      --success:#059669; --success-bg:#ecfdf5; --success-bd:#a7f3d0;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:"Noto Sans KR","Poppins",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
              radial-gradient(1200px 600px at -10% -20%, rgba(42,193,188,.10), transparent 60%),
              radial-gradient(900px 500px at 120% 110%, rgba(42,193,188,.08), transparent 55%),
              linear-gradient(180deg,#f8fafc 0%, #f3f7fb 100%);
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:20;
      background:rgba(255,255,255,.8);
      backdrop-filter:saturate(1.1) blur(8px);
      border-bottom:1px solid rgba(15,23,42,.06);
    }
    .appbar{max-width:900px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:900;
      text-decoration:none;color:#0b3d3b; letter-spacing:-.2px;
      outline: none;
    }
    .brand-badge{
      width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
      background:var(--brand);color:#fff;font-weight:900;
      box-shadow:0 6px 14px rgba(42,193,188,.35);
      transition: transform .16s ease, box-shadow .16s ease, filter .16s ease;
      will-change: transform;
    }
    .brand:hover .brand-badge,
    .brand:focus-visible .brand-badge{
      transform: translateY(-1px) scale(1.08);
      box-shadow:0 12px 26px rgba(42,193,188,.38), inset 0 0 0 1px rgba(255,255,255,.55);
      filter: saturate(1.05);
    }
    @media (prefers-reduced-motion: reduce){
      .brand-badge{ transition: none }
    }

    .nav-actions a{margin-left:10px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#111827;text-decoration:none;font-weight:800;transition:.2s}
    .nav-actions a:hover{background:var(--brand);color:#fff;border-color:var(--brand)}

    main{max-width:900px;margin:22px auto 60px;padding:0 20px;display:grid;gap:18px}

    .card{backdrop-filter:blur(8px) saturate(1.05);background:var(--glass);
      border:1px solid rgba(2,6,23,.08);border-radius:24px;box-shadow:var(--shadow);padding:20px}
    .card h1{margin:0 0 10px;font-size:20px;font-weight:900}
    .sub{margin:-4px 0 10px;color:var(--muted);font-weight:600}

    /* Alerts */
    .alert-error{
      background:#fef2f2; border:1px solid #fecaca; color:#991b1b;
      padding:10px 12px; border-radius:12px; margin-bottom:10px; font-weight:800;
    }
    .alert-success{
      background:var(--success-bg); border:1px solid var(--success-bd); color:var(--success);
      padding:10px 12px; border-radius:12px; margin-bottom:10px; font-weight:800;
    }

    label{display:block;font-size:13px;font-weight:800;color:#334155;margin:0 0 6px}
    .input, textarea{
      width:100%;border-radius:12px;border:1px solid var(--line);background:#f9fafb;
      padding:12px 14px;font-size:15px;transition:border-color .15s,box-shadow .15s,background .15s
    }
    .input{height:52px;}
    textarea{min-height:90px;resize:vertical;max-length:500}
    .input:focus, textarea:focus{outline:none;border-color:#8ee2df;background:#fff;box-shadow:0 0 0 4px rgba(42,193,188,.15)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}

    .error{margin-top:6px;color:#b91c1c;font-size:13px}
    .field-error{border-color:#dc2626 !important; background:#fff7f7}

    .actions{display:flex;gap:10px;margin-top:16px}
    .btn{border:none;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .btn-primary{background:var(--brand);color:#fff;box-shadow:0 8px 20px rgba(42,193,188,.35)}
    .btn-primary:hover{background:var(--brand-d)}
    .btn-ghost{background:#fff;border:1px solid var(--line);color:#111827}
    .btn-ghost:hover{box-shadow:0 8px 20px rgba(2,6,23,.06)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{background:var(--danger-d)}

    .preview{
      margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;
      display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center
    }
    .pv-left{display:flex;gap:22px}
    .pv-label{color:var(--muted);font-weight:800;font-size:13px}
    .pv-value{font-weight:900}
    .pv-thumb{
      width:84px;height:84px;border-radius:10px;background:#f3f5f7;border:1px solid #e6ecef;
      overflow:hidden;display:grid;place-items:center;color:#0b3d3b;font-weight:900
    }
    .pv-thumb img{width:100%;height:100%;object-fit:cover}
    .pv-desc{margin-top:8px;font-size:14px;color:#374151;white-space:pre-line}
    .hint{color:#6b7280;font-size:12px;margin-top:6px}
  </style>
</head>
<body>

<!-- Appbar -->
<header>
  <div class="appbar">
    <a class="brand" th:href="@{/home}" aria-label="홈으로">
      <div class="brand-badge">드</div>
      <span>상품 수정</span>
    </a>
    <div class="nav-actions">
      <a th:href="@{/owner/stores/{storeId}(storeId=${storeId})}">가게 상세</a>
    </div>
  </div>
</header>

<main>
  <section id="edit-menu" class="card">
    <h1>상품 수정</h1>
    <p class="sub">상품명, 가격, 기본 수량, <b>이미지 URL</b>과 <b>상품 설명</b>을 수정하세요.</p>

    <!-- ✅ 플래시 메시지 표시 (컨트롤러 RedirectAttributes 사용 시) -->
    <div class="alert-error" th:if="${formError}" th:text="${formError}">오류가 발생했습니다.</div>
    <div class="alert-success" th:if="${pageMessage}" th:text="${pageMessage}">수정 완료</div>

    <form th:action="@{/owner/stores/{storeId}/products/{productId}/edit(storeId=${storeId}, productId=${productId})}"
          th:object="${foodDTO}" method="post" novalidate>
      <!-- CSRF -->
      <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <div class="field">
        <label for="foodName">상품명</label>
        <input id="foodName" class="input" type="text" th:field="*{foodName}" required
               minlength="1" maxlength="60"
               th:classappend="${#fields.hasErrors('foodName')} ? ' field-error'">
        <div class="error" th:if="${#fields.hasErrors('foodName')}" th:errors="*{foodName}">오류</div>
      </div>

      <div class="row">
        <div class="field">
          <label for="foodPrice">가격(원)</label>
          <input id="foodPrice" class="input" type="number" th:field="*{foodPrice}"
                 min="0" step="100" required
                 oninput="this.value = this.value < 0 ? 0 : this.value"
                 th:classappend="${#fields.hasErrors('foodPrice')} ? ' field-error'">
          <div class="error" th:if="${#fields.hasErrors('foodPrice')}" th:errors="*{foodPrice}">오류</div>
        </div>

        <div class="field">
          <label for="quantity">수량</label>
          <input id="quantity" class="input" type="number" th:field="*{quantity}"
                 min="1" step="1" required
                 oninput="this.value = this.value < 1 ? 1 : this.value"
                 th:classappend="${#fields.hasErrors('quantity')} ? ' field-error'">
          <div class="error" th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}">오류</div>
        </div>
      </div>

      <div class="field">
        <label for="productImageUrl">이미지 URL</label>
        <input id="productImageUrl" class="input" type="url" th:field="*{productImageUrl}"
               placeholder="https://예시.com/image.jpg"
               pattern="https?://.*\.(jpg|jpeg|png|gif|webp)(\?.*)?$"
               title="http(s):// 로 시작하고 jpg/png/gif/webp 파일이어야 합니다.">
        <div class="hint">정적 URL을 넣으면 상품 목록/상세에 바로 표시됩니다. 비어 있으면 기본 플레이스홀더가 보여요.</div>
        <div class="error" th:if="${#fields.hasErrors('productImageUrl')}" th:errors="*{productImageUrl}">오류</div>
      </div>

      <div class="field">
        <label for="productDescription">상품 설명 <span style="font-weight:600; color:var(--muted)">(최대 500자)</span></label>
        <textarea id="productDescription" th:field="*{productDescription}" maxlength="500"
                  placeholder="상품에 대한 설명을 입력하세요."></textarea>
        <div class="error" th:if="${#fields.hasErrors('productDescription')}" th:errors="*{productDescription}">오류</div>
        <div class="hint">현재 글자수:
          <span id="descCount"
                th:text="${foodDTO != null && foodDTO.productDescription != null ? #strings.length(foodDTO.productDescription) : 0}">0</span>자
        </div>
      </div>

      <!-- 미리보기 -->
      <div class="preview" aria-live="polite">
        <div class="pv-left">
          <div class="pv-thumb">
            <img id="pvImg" alt="미리보기 이미지" style="display:none" referrerpolicy="no-referrer">
            <span id="pvFallback">미리보기</span>
          </div>
          <div>
            <div class="pv-label">총액(미리보기)</div>
            <div class="pv-value" id="pvTotal">- 원</div>
            <p id="pvDesc" class="pv-desc" th:text="${foodDTO?.productDescription} ?: ' '"> </p>
          </div>
        </div>
        <div>
          <div class="pv-label">단가</div>
          <div class="pv-value" id="pvUnit">- 원</div>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary">수정하기</button>
        <a class="btn btn-ghost" th:href="@{/owner/stores/{storeId}(storeId=${storeId})}">가게 상세로</a>
      </div>
    </form>
  </section>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ===== 금액 미리보기 =====
    const priceEl = document.getElementById('foodPrice');
    const qtyEl   = document.getElementById('quantity');
    const unitEl  = document.getElementById('pvUnit');
    const totalEl = document.getElementById('pvTotal');

    function fmt(n){ return (isNaN(n) || n === '' || n == null) ? '- 원' : Number(n).toLocaleString('ko-KR') + '원'; }
    function updatePrice(){
      const p = Number(priceEl?.value || 0);
      const q = Math.max(1, Number(qtyEl?.value || 1));
      unitEl.textContent  = fmt(p);
      totalEl.textContent = fmt(p * q);
    }
    ['input','change'].forEach(ev => {
      priceEl?.addEventListener(ev, updatePrice);
      qtyEl?.addEventListener(ev, updatePrice);
    });
    updatePrice();

    // ===== 이미지 미리보기 =====
    const imgInput   = document.getElementById('productImageUrl');
    const pvImg      = document.getElementById('pvImg');
    const pvFallback = document.getElementById('pvFallback');

    const IMG_URL_RE = /(https?:\/\/[^\s"'<>]+?\.(?:jpg|jpeg|png|gif|webp))(?:\?[^\s"']*)?/i;

    function extractImageUrl(text){
      if (!text) return '';
      const m = String(text).match(IMG_URL_RE);
      return m ? m[1] : '';
    }

    function setPreview(url){
      if (!url){
        pvImg.style.display = 'none';
        pvImg.removeAttribute('src');
        pvFallback.style.display = 'grid';
        return;
      }
      const test = new Image();
      test.onload = () => {
        pvImg.src = url;
        pvImg.style.display = 'block';
        pvFallback.style.display = 'none';
      };
      test.onerror = () => {
        pvImg.style.display = 'none';
        pvImg.removeAttribute('src');
        pvFallback.style.display = 'grid';
      };
      test.referrerPolicy = 'no-referrer';
      test.src = url;
    }

    function updatePreviewFromInput(){
      const raw = imgInput?.value?.trim();
      const url = extractImageUrl(raw);
      setPreview(url);
    }

    if (imgInput){
      ['input','change','paste','blur'].forEach(ev =>
              imgInput.addEventListener(ev, updatePreviewFromInput)
      );
      updatePreviewFromInput();
    }

    // ===== 설명 글자수 카운트 =====
    const descInput = document.getElementById('productDescription');
    const descCount = document.getElementById('descCount');
    if (descInput && descCount){
      const updateCount = () => { descCount.textContent = descInput.value.length; };
      ['input','change'].forEach(ev => descInput.addEventListener(ev, updateCount));
      updateCount();
    }
  });
</script>

</body>
</html>
