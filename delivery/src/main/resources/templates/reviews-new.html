<!-- src/main/resources/templates/reviews-new.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>배달의 드론 | 리뷰 작성</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root{
            --mint:#2AC1BC; --mint-d:#21a7a2;
            --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb; --card:#ffffff;
            --border:#e5e7eb; --shadow:0 10px 24px rgba(15,23,42,.08), 0 2px 6px rgba(15,23,42,.06);
            --radius:18px; --radius-lg:22px;
            --star:#f59e0b; --star-empty:#e5e7eb;
            --danger:#b91c1c;
        }
        *{box-sizing:border-box}
        body{
            margin:0; font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--ink);
            background:
                    radial-gradient(circle at 0 0, rgba(15,23,42,.06) 0, rgba(15,23,42,.06) 1px, transparent 1px),
                    linear-gradient(180deg, #fafbff 0%, var(--bg) 100%);
            background-size:18px 18px, auto; background-attachment:fixed;
        }

        /* ===== Glass App Bar (shrink + underline) ===== */
        .appbar{
            position:sticky; top:0; z-index:50;
            background:linear-gradient(180deg,rgba(255,255,255,.78),rgba(255,255,255,.58));
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border-bottom:1px solid var(--border);
        }
        .appbar::after{
            content:""; position:absolute; inset:0 0 auto 0; height:1px;
            background:linear-gradient(90deg,transparent,rgba(42,193,188,.35),transparent);
            pointer-events:none;
        }
        .appbar-inner{
            max-width:1200px; margin:0 auto; padding:14px 20px;
            display:flex; align-items:center; justify-content:space-between;
            transition:padding .18s ease;
        }
        .appbar.is-scrolled .appbar-inner{ padding:8px 20px }

        .brand{ display:flex; align-items:center; gap:10px; font-weight:900; color:#0b3d3b; text-decoration:none; }
        .logo{
            width:36px; height:36px; display:grid; place-items:center; background:var(--mint); color:#fff;
            border-radius:12px; font-weight:900; box-shadow:0 8px 18px rgba(42,193,188,.28); transition:transform .18s ease;
        }
        .brand:hover .logo{ transform:translateY(-1px) scale(1.03) }

        .nav{ display:flex; align-items:center; gap:6px }
        .nav a{
            position:relative; text-decoration:none; color:var(--muted); padding:8px 12px; border-radius:10px; font-weight:800;
            transition:color .15s ease, background-color .15s ease;
        }
        .nav a::after{
            content:""; position:absolute; left:12px; right:12px; bottom:6px; height:2px;
            background:linear-gradient(90deg,#2AC1BC,#0ea5a0);
            border-radius:2px; transform:scaleX(0); transform-origin:left; transition:transform .18s ease;
        }
        .nav a:hover{ color:#0b3d3b; background:rgba(42,193,188,.06) }
        .nav a:hover::after{ transform:scaleX(1) }
        .nav a.active{ color:#0b3d3b; background:rgba(42,193,188,.10) }
        .nav a.active::after{ transform:scaleX(1) }

        /* Page */
        .wrap{ max-width:1200px; margin:26px auto 80px; padding:0 20px; }
        .page-head{ background:linear-gradient(180deg,#e9fbfa,#f7fffe); border:1px solid #dbf5f2; padding:22px; border-radius:var(--radius-lg); box-shadow:var(--shadow); }
        .page-head h1{ margin:0; font-size:28px; letter-spacing:-.3px; }
        .page-head .sub{ margin-top:6px; color:#64748b; }

        .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); box-shadow:var(--shadow); padding:18px; margin-top:18px; }
        .field{ margin:14px 0; }
        .label{ display:block; font-weight:800; margin-bottom:8px; }
        .help{ color:#64748b; font-size:13px; margin-top:4px; }
        .error{ color:var(--danger); font-size:13px; margin-top:6px; }

        /* Star rating */
        .star-rating{ display:flex; gap:8px; align-items:center; flex-direction:row-reverse; }
        .star-rating input{ display:none; }
        .star-rating label{ width:38px; height:38px; cursor:pointer; user-select:none; display:grid; place-items:center; border-radius:10px; }
        .star-rating .icon{ width:100%; height:100%; fill:var(--star-empty); transition:fill .12s ease; }
        .star-rating input:checked + label .icon,
        .star-rating input:checked ~ label .icon{ fill:var(--star); }
        .star-rating label:hover .icon,
        .star-rating label:hover ~ label .icon{ fill:var(--star); }
        .star-rating label:focus-visible{ outline:2px solid var(--mint); outline-offset:2px; }

        textarea{
            width:100%; min-height:140px; resize:vertical; padding:12px; border:1px solid #e5e7eb;
            border-radius:12px; font:inherit; line-height:1.6; background:#fff;
        }

        .actions{ display:flex; gap:10px; margin-top:12px; }
        .btn{ display:inline-block; padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:800; border:1px solid #e5e7eb; background:#f8fafc; color:#0f172a; }
        .btn:hover{ background:#eef2f7; }
        .btn.primary{ background:var(--mint); border-color:var(--mint); color:#fff; box-shadow:0 10px 18px rgba(42,193,188,.22); }
        .btn.primary:hover{ background:var(--mint-d); }

        /* 파일 미리보기 */
        .preview-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:12px; margin-top:10px; }
        .thumb{ border:1px solid var(--border); border-radius:12px; padding:6px; background:#fff; display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; }
        .thumb img{ max-width:100%; height:96px; object-fit:cover; border-radius:8px; }
        .thumb .name{ font-size:12px; color:#475569; text-align:center; word-break:break-all; }
        .counter{ font-size:13px; color:#475569; margin-top:6px; }
        .counter.bad{ color:#b91c1c; font-weight:700; }

        @media (max-width:720px){
            .nav a{ padding:8px 10px }
        }
    </style>
</head>
<body>

<header class="appbar" id="appbar">
    <div class="appbar-inner">
        <!-- 홈은 /home → 역할별 리다이렉트 -->
        <a class="brand" th:href="@{/home}">
            <span class="logo">드</span> 배달의 드론
        </a>

        <!-- 세션 분기: OWNER면 정보보기/로그아웃만 -->
        <nav class="nav"
             th:with="
           loginMember=${session['loginMember']},
           isOwner=${loginMember != null and loginMember.memberType == T(drone.delivery.domain.MemberType).OWNER}
         ">
            <a th:if="${!isOwner}" th:href="@{/reviews}"  th:classappend="${page=='reviews'} ? ' active'">나의리뷰</a>
            <a th:if="${!isOwner}" th:href="@{/orders}"   th:classappend="${page=='orders'} ? ' active'">주문내역</a>
            <a th:if="${!isOwner}" th:href="@{/recharge}" th:classappend="${page=='recharge'} ? ' active'">돈충전</a>

            <a th:href="@{/account}" th:classappend="${page=='account'} ? ' active'">정보보기</a>
            <a th:href="@{/logout}">로그아웃</a>
        </nav>
    </div>
</header>

<main class="wrap">
    <section class="page-head">
        <h1 th:text="'리뷰 작성 — ' + ${storeName}">리뷰 작성 — 가게 이름</h1>
        <div class="sub">
            주문번호 <strong th:text="${order.id}">1</strong>
            · 주문시간 <strong th:text="${#temporals.format(order.createdDate,'yyyy.MM.dd HH:mm')}">2025.09.09 12:34</strong>
            · 상태 <strong th:text="${order.orderStatus.name()}">DELIVERED</strong>
        </div>
    </section>

    <section class="card">
        <!-- 한 번에 제출: 본문 + 이미지 -->
        <form th:action="@{/reviews}" th:object="${form}" method="post" enctype="multipart/form-data">
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="hidden" th:field="*{orderId}">
            <input type="hidden" th:field="*{storeId}">

            <!-- 별점 -->
            <div class="field">
                <label class="label">별점</label>
                <div class="star-rating" role="radiogroup" aria-label="별점">
                    <input id="rate5" type="radio" th:field="*{rating}" value="5"/><label for="rate5" aria-label="5점"><svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></label>
                    <input id="rate4" type="radio" th:field="*{rating}" value="4"/><label for="rate4" aria-label="4점"><svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></label>
                    <input id="rate3" type="radio" th:field="*{rating}" value="3"/><label for="rate3" aria-label="3점"><svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></label>
                    <input id="rate2" type="radio" th:field="*{rating}" value="2"/><label for="rate2" aria-label="2점"><svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></label>
                    <input id="rate1" type="radio" th:field="*{rating}" value="1"/><label for="rate1" aria-label="1점"><svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></label>
                </div>
                <div class="error" th:if="${#fields.hasErrors('rating')}" th:errors="*{rating}">별점 에러</div>
                <div class="help">노란 별이 선택된 개수만큼 별점이 등록됩니다. (1~5)</div>
            </div>

            <!-- 내용 -->
            <div class="field">
                <label for="content" class="label">리뷰 내용</label>
                <textarea id="content" th:field="*{content}" placeholder="맛/양/배송 속도 등 솔직한 후기를 남겨주세요. (최대 1000자)"></textarea>
                <div class="error" th:if="${#fields.hasErrors('content')}" th:errors="*{content}">내용 에러</div>
            </div>

            <!-- 사진 첨부 -->
            <div class="field">
                <label class="label" for="files">사진 첨부</label>
                <input id="files" type="file" name="files" accept="image/*" multiple />
                <div class="help">최대 10장, JPG/PNG/WEBP/GIF / 파일당 최대 10MB</div>
                <div id="fileCounter" class="counter"></div>
                <div id="fileError" class="error" style="display:none;"></div>
                <div id="preview" class="preview-grid" aria-live="polite"></div>
            </div>

            <div class="actions">
                <button type="submit" class="btn primary">리뷰 등록</button>
                <a th:href="@{/orders}" class="btn">목록으로</a>
            </div>
        </form>
    </section>
</main>

<script>
    // 헤더 스크롤 축소
    (function(){
        const bar = document.getElementById('appbar');
        const onScroll = () => {
            if (window.scrollY > 8) bar.classList.add('is-scrolled');
            else bar.classList.remove('is-scrolled');
        };
        onScroll();
        window.addEventListener('scroll', onScroll, {passive:true});
    })();

    // 파일 미리보기/검증
    (function(){
        const input = document.getElementById('files');
        const preview = document.getElementById('preview');
        const counter = document.getElementById('fileCounter');
        const errBox = document.getElementById('fileError');

        const MAX_FILES = 10;
        const MAX_SIZE = 10 * 1024 * 1024; // 10MB

        function resetPreview(){
            preview.innerHTML = '';
            counter.textContent = '';
            errBox.style.display = 'none';
            errBox.textContent = '';
            counter.classList.remove('bad');
        }
        function formatBytes(bytes){
            const units = ['B','KB','MB','GB'];
            let i = 0, v = bytes;
            while(v >= 1024 && i < units.length-1){ v /= 1024; i++; }
            return (Math.round(v * 10) / 10) + ' ' + units[i];
        }

        input.addEventListener('change', () => {
            resetPreview();
            const files = Array.from(input.files || []);
            const tooMany = files.length > MAX_FILES;
            const tooBig  = files.some(f => f.size > MAX_SIZE);

            counter.textContent = `선택된 파일: ${files.length}개 / 최대 ${MAX_FILES}개`;
            if (tooMany) counter.classList.add('bad');

            if (tooMany || tooBig) {
                errBox.style.display = 'block';
                errBox.textContent =
                    (tooMany ? `파일은 최대 ${MAX_FILES}개까지 선택할 수 있어요. ` : '') +
                    (tooBig ? `파일당 크기는 최대 10MB까지예요.` : '');
            }

            files.forEach(file => {
                const wrap = document.createElement('div');
                wrap.className = 'thumb';
                const img = document.createElement('img');
                img.alt = file.name;
                const name = document.createElement('div');
                name.className = 'name';
                name.textContent = `${file.name} (${formatBytes(file.size)})`;

                const reader = new FileReader();
                reader.onload = e => { img.src = e.target.result; };
                reader.readAsDataURL(file);

                wrap.appendChild(img);
                wrap.appendChild(name);
                preview.appendChild(wrap);
            });
        });
    })();
</script>
</body>
</html>
